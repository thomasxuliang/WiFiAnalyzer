{
  "id": "snapshot_1764745201805_setr6omii",
  "approvalId": "approval_1764745201795_bzouqzn5i",
  "approvalTitle": "WiFi Sniffer Design",
  "version": 1,
  "timestamp": "2025-12-03T07:00:01.805Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\r\n\r\n## Overview\r\n\r\nThe WiFi Sniffer feature transforms the WiFiAnalyzer app into a packet capture tool for rooted Qualcomm wcn7750 devices. It introduces a `SnifferManager` to handle privileged shell commands for driver manipulation and `tcpdump` execution. The UI integration allows users to initiate capture directly from the Access Point list.\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards\r\n-   **Root Access Pattern**: Uses a dedicated `RootShellExecutor` to encapsulate `su` calls, keeping the rest of the app clean.\r\n-   **State Management**: Uses a Singleton `SnifferManager` to track the device state (Scanning vs. Sniffing).\r\n\r\n### Project Structure\r\n-   New package `com.vrem.wifianalyzer.wifi.sniffer` will contain all sniffer-related logic.\r\n-   Modifications to `com.vrem.wifianalyzer.wifi.accesspoint` will be minimal, restricted to UI hooks.\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n-   **`WiFiDetail`**: Used to extract channel and bandwidth information for the target AP.\r\n-   **`MainContext`**: Used to access global services/singletons.\r\n\r\n### Integration Points\r\n-   **`AccessPointsAdapter` / `AccessPointDetail`**: The entry point for the user to start sniffing.\r\n-   **`ScannerService`**: Needs to be paused/stopped when Sniffer Mode is active, as the wifi interface will be taken down.\r\n\r\n## Architecture\r\n\r\n### Modular Design Principles\r\n-   **`RootShellExecutor`**: Handles low-level shell execution.\r\n-   **`SnifferManager`**: Business logic for the specific wcn7750 command sequence.\r\n-   **`SnifferState`**: Sealed class representing the current state (Idle, Preparing, Capturing, Error).\r\n\r\n```mermaid\r\ngraph TD\r\n    UI[AccessPointDetail View] -->|Click Start| Manager[SnifferManager]\r\n    Manager -->|Execute| Shell[RootShellExecutor]\r\n    Shell -->|Commands| System[Android System / Kernel]\r\n    Manager -->|Update State| UI\r\n```\r\n\r\n## Components and Interfaces\r\n\r\n### `RootShellExecutor`\r\n-   **Purpose:** Execute shell commands with root privileges.\r\n-   **Interfaces:**\r\n    -   `execute(command: String): Boolean`\r\n    -   `executeSequence(commands: List<String>): Boolean`\r\n\r\n### `SnifferManager`\r\n-   **Purpose:** Coordinate the sniffer workflow.\r\n-   **Interfaces:**\r\n    -   `startCapture(channel: Int, bandwidth: Int): Boolean`\r\n    -   `stopCapture(): Boolean`\r\n    -   `isCapturing(): Boolean`\r\n-   **Dependencies:** `RootShellExecutor`\r\n\r\n### `AccessPointDetail` (Modification)\r\n-   **Purpose:** Display AP details and now the \"Start Sniffer\" button.\r\n-   **Modifications:**\r\n    -   Add \"Start/Stop Capture\" button to the view.\r\n    -   Bind button click to `SnifferManager`.\r\n\r\n## Data Models\r\n\r\n### `SnifferConfig`\r\n```kotlin\r\ndata class SnifferConfig(\r\n    val channel: Int,\r\n    val bandwidth: Int,\r\n    val outputFileName: String\r\n)\r\n```\r\n\r\n## Error Handling\r\n\r\n### Error Scenarios\r\n1.  **Root Permission Denied**:\r\n    -   **Handling**: Catch exception, set state to Error.\r\n    -   **User Impact**: Show Toast/Snackbar \"Root permission required\".\r\n2.  **Driver Reload Fail**:\r\n    -   **Handling**: Abort sequence, attempt to restore Wifi service.\r\n    -   **User Impact**: Show \"Failed to enable monitor mode\".\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n-   Test `SnifferManager` state transitions (mocking `RootShellExecutor`).\r\n-   Test command string generation.\r\n\r\n### Manual Testing\r\n-   Verify on wcn7750 device.\r\n-   Check `tcpdump` process running via adb.\r\n-   Verify `.pcap` file creation in `/data/local/temp/`.\r\n",
  "fileStats": {
    "size": 3534,
    "lines": 95,
    "lastModified": "2025-12-03T06:59:51.544Z"
  },
  "comments": []
}